# Бэкенд

Написано на связке Rust + Axum. БД - PostgreSQL, для кэшей используем Redis.

## Запуск

Всё поднимается с помощью Docker-Compose. Перед тем, как поднимать сервис,
нужно приложить к нему правильные переменные окружения.

```shell
cp .env.example .env
```

Для работы с Yandex.Cloud Video API (храним там видео лекций) понадобится ключ от сервис-аккаунта, его можно получить так:

```shell
yc iam key create --service-account-name sa-video-api --output iam-key.json
```

Путь до полученного IAM-ключа нужно указать в переменных.
При этом в организации в YC CLI должна стоять infosec.moscow. Подробнее про YC CLI - [тут](https://yandex.cloud/ru/docs/cli)

Остальные переменные нужно забрать у текущих мейнтейнеров (@justmarfix и @cfrt-dev на момент написания).

После этого можно спокойно поднимать приложение - `docker compose up -d`.

## Работа с БД

Для консистентной работы с данными мы используем миграции через SQLx.

Добавить новую миграцию:

```shell
cargo sqlx migrate add 'migrate description'
```

Это создаст два новых файла: `datetime_migrate_description_up.sql` и `datetime_migrate_description_down.sql` в директории `migrations`.
В них нужно ручками написать SQL-код, который создаст нужные структуры (и уберёт их, если речь про down-файл).

Накатить миграции:
```shell
cargo sqlx migrate run
```

Откатить последнюю накаченную миграцию:
```shell
cargo sqlx migrate revert
```

Если вы изменяете SQL-запросы в коде - не забывайте делать `cargo sqlx prepare` перед коммитом - это проверит запросы на валидность и канонизирует результаты.

## Структура

Глобально у нас есть четыре больших области хранения данных и логики:

- api
- domain
- infrastructure
- dto

В `api` хранится код ручек API.

В `domain` - вся связанная с конкретной сущностью информация: в модуле `model.rs` - модели (в том числе для БД), в `repository.rs` - трейт для работы с данными,
а в `service.rs` - вся внутренняя логика обработки данных.

В `infrastructure` хранится много сервисного кода, но в модуле `db` реализуются трейты работы с данными, описанные в `repository.rs` (см. выше).

В `dto` лежат объекты и схемы для обмена данными, не вошедшие в `model.rs` домена.

Помимо областей хранения данных, мы также выделяем несколько частей из нашего монолита: LMS и паспорт. LMS отвечает за работу с экзаменами,
ответами и прочей учебными штуками, в то время как паспорт является единой хранилкой ACLов, доступов, авторизационных данных юзеров и прочего auth-связанного.

## Кодстайл

Ниже содержатся несколько кодстайл-правил и рекомендаций по разработке, которых мы стараемся придерживаться.

- Перед коммитом запускаем `cargo fmt --all`
- В SQL-запросе текст запроса должен быть в одной табуляции справа от кавычек (см. существующие запросы)
- В реализации трейта порядок методов должен быть таким же, как и в его определении

## CI/CD

В репозитории работает GitHub Actions, который прогоняет Clippy в PR, а в мастере - собирает проект с `--release` и пушит его в Container Registry.

## OpenAPI

Для генерации openapi.json, требуется запустить приложение с фичей gen-openapi - `cargo run -F gen-openapi`. Для этого не требуются переменные окружения или любые другие зависимости.
